name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18'
          otp-version: '27'

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: deps
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get --only prod

      - name: Compile project
        run: MIX_ENV=prod mix compile

      - name: Build hex archive
        run: MIX_ENV=prod mix archive.build

      - name: Verify artifacts
        run: |
          ls -lh ragex-*.ez
          echo "Archive size: $(du -h ragex-*.ez | cut -f1)"

      - name: Generate checksums
        run: |
          sha256sum ragex-*.ez > ragex-archive.sha256
          cat ragex-archive.sha256

      - name: Create release notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## Installation

          ### Hex Archive (Global Mix Tasks)

          Install directly from Hex:

          ```bash
          mix archive.install hex ragex
          ```

          Or download and install the archive:

          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ragex-${{ steps.version.outputs.version }}.ez
          mix archive.install ragex-${{ steps.version.outputs.version }}.ez
          ```

          ### Mix Dependency (Recommended)

          Add to your `mix.exs`:

          ```elixir
          def deps do
            [
              {:ragex, "~> ${{ steps.version.outputs.version }}"}
            ]
          end
          ```

          Then run:

          ```bash
          mix deps.get
          ```

          ### CLI Tools

          With hex archive or as dependency:

          ```bash
          # Cross-language analysis
          mix ragex.analyze --path /path/to/your/project
          ```

          ## What's Changed

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for detailed changes.

          ## Verification

          Verify the downloaded files using SHA256 checksums:

          ```bash
          sha256sum -c ragex-archive.sha256
          ```
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ragex-*.ez
            ragex-archive.sha256
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') || contains(github.ref, 'dev') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-hex:
    name: Publish to Hex.pm
    runs-on: ubuntu-latest
    needs: build
    if: "!contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') && !contains(github.ref, 'dev')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18'
          otp-version: '27'

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: deps
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Publish to Hex
        run: mix hex.publish --yes
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [build, publish-hex]
    if: always()
    steps:
      - name: Check release status
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build failed!"
            exit 1
          fi
          
          if [ "${{ needs.publish-hex.result }}" == "skipped" ]; then
            echo "Hex publishing skipped (pre-release)"
          elif [ "${{ needs.publish-hex.result }}" != "success" ]; then
            echo "Hex publishing failed!"
            exit 1
          fi
          
          echo "Release completed successfully!"
          echo "Download artifacts from: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
